<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Gerenciar Boletins</title>
    <link rel="stylesheet" href="css/admin.css">
</head>
<body>
    <!-- Menu Lateral -->
    <div class="sidebar">
        <h2>Administração</h2>
        <ul>
            <li><a href="dashboard.html">⬅️ Voltar ao Painel</a></li>
        </ul>
    </div>

    <!-- Conteúdo Principal -->
    <div class="main-content">
        <h1>📂 Gerenciar Boletins</h1>

        <section class="secao">
            <h2>📤 Enviar Novo Boletim</h2>
            <input type="file" id="boletimFile" accept=".pdf">
            <button onclick="uploadBoletim()">Enviar Boletim</button>
        </section>

        <section class="secao">
            <h2>📜 Boletins Publicados</h2>
            <div id="lista-boletins"></div>
        </section>
    </div>

    <script>
        const GITHUB_USERNAME = "tharlesjcp";
        const REPO_NAME = "iprc-boletins";
        const BRANCH_NAME = "main";
        const ACCESS_TOKEN = process.env.PATH_REPO || "";

        async function uploadBoletim() {
            const fileInput = document.getElementById("boletimFile");
            const file = fileInput.files[0];

            if (!file) {
                alert("Selecione um arquivo PDF primeiro.");
                return;
            }

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                const base64Content = reader.result.split(",")[1];
                const fileName = `boletim_${new Date().toISOString().split("T")[0]}.pdf`;
                const apiUrl = `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${fileName}`;

                const response = await fetch(apiUrl, {
                    method: "PUT",
                    headers: {
                        "Authorization": `token ${ACCESS_TOKEN}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        message: `📄 Adicionando boletim: ${fileName}`,
                        content: base64Content,
                        branch: BRANCH_NAME
                    })
                });

                if (response.ok) {
                    alert("✅ Boletim enviado com sucesso!");
                    carregarBoletins();
                } else {
                    alert("❌ Erro ao enviar boletim. Verifique suas credenciais.");
                }
            };
        }

        async function carregarBoletins() {
            const apiUrl = `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/`;
            const response = await fetch(apiUrl, {
                headers: { "Authorization": `token ${ACCESS_TOKEN}` }
            });
            const data = await response.json();

            const listaBoletins = document.getElementById("lista-boletins");
            listaBoletins.innerHTML = "";

            data.filter(file => file.name.endsWith(".pdf")).forEach(file => {
                const link = document.createElement("a");
                link.href = file.download_url;
                link.textContent = file.name;
                link.target = "_blank";

                const div = document.createElement("div");
                div.appendChild(link);
                listaBoletins.appendChild(div);
            });
        }

        carregarBoletins();
    </script>
</body>
</html>
